// 嵌入式語言資料
const LANGUAGE_DATA = {
  "en": {"meta":{"title":"Dopi Note — Meeting Recording, Transcription in 1 Minute","description":"Dopi Note: AI smart recording notes, complete transcription and key point summary in 1 minute. No login required, high privacy, supports 20+ languages."},"og":{"title":"Dopi Note — Meeting Recording, Transcription in 1 Minute","description":"AI smart summary makes every word valuable. No login required, high privacy, supports 20+ languages."},"nav":{"brand":"Dopi Note","download":"Download Now"},"useCases":{"title":"Do you also face these challenges?","meeting":{"title":"During Meetings","description":"Want to focus but have to take notes"},"interview":{"title":"During Interviews","description":"Hope to listen attentively but need to record every word"},"lecture":{"title":"During Lectures","description":"Non-native language is hard to understand, fast pace is hard to follow"}},"features":{"title":"Dopi Note Is Here to Help","assistant":{"title":"Most Powerful Meeting Assistant","items":["Automatically recognizes multiple languages, quickly generates transcripts","Automatically identifies scenarios, generates traceable summaries","Automatically translates meeting records to your language"]},"security":{"title":"Most Secure Data Management","items":["No login required, completely offline available","Login for cloud sync, no worry about data loss"]},"pricing":{"title":"Most Flexible Payment Model","items":["No subscription, purchase hours to enjoy full features","Pay as you use, super flexible","Hours never expire"]}},"slogan":{"title":"You just focus, let AI note"},"download":{"title":"Dopi Note - The Ultimate Meeting Assistant"},"contact":{"label":"Contact Us:","email":"yijhen.yang@gmail.com"},"footer":{"copyright":"© 2025 Dopi Note. All rights reserved."}},
  "zh-TW": {"meta":{"title":"Dopi Note — 會議錄音，1分鐘變逐字稿","description":"Dopi Note：AI 智慧錄音筆記，1分鐘完成逐字稿與重點整理。免登入、高隱私、支援20+語言。"},"og":{"title":"Dopi Note — 會議錄音，1分鐘變逐字稿","description":"AI 智慧摘要，讓每句話都有價值。免登入、高隱私、支援20+語言。"},"nav":{"brand":"Dopi Note","download":"立即下載"},"useCases":{"title":"你是否也有這些困擾？","meeting":{"title":"開會時","description":"想專心討論，卻得分心做筆記"},"interview":{"title":"訪談時","description":"希望專注聆聽，但需完整記錄每句話"},"lecture":{"title":"聽演講時","description":"非母語好難懂，語速快跟不上"}},"features":{"title":"Dopi Note 來幫你","assistant":{"title":"最強大的會議助理","items":["自動辨識多國語言，快速生成逐字稿","自動辨識場景，生成可溯源的摘要","自動將會議記錄翻譯成你的語言"]},"security":{"title":"最安全的資料管理","items":["不需登入，完全離線可用","登入可享雲端同步，不用擔心資料遺失"]},"pricing":{"title":"最彈性的付費機制","items":["免訂閱，購買時數即可享有全功能","用多少買多少，超彈性","時數永不過期"]}},"slogan":{"title":"你只需專注，讓AI紀錄"},"download":{"title":"Dopi Note - 最強會議助理"},"contact":{"label":"聯絡我們：","email":"yijhen.yang@gmail.com"},"footer":{"copyright":"© 2025 Dopi Note. All rights reserved."}},
  "ja": {"meta":{"title":"Dopi Note — 会議録音、1分で文字起こし","description":"Dopi Note：AI スマート録音ノート、1分で文字起こしと要点整理を完了。ログイン不要、高プライバシー、20以上の言語をサポート。"},"og":{"title":"Dopi Note — 会議録音、1分で文字起こし","description":"AI スマート要約で、すべての言葉に価値を。ログイン不要、高プライバシー、20以上の言語をサポート。"},"nav":{"brand":"Dopi Note","download":"今すぐダウンロード"},"useCases":{"title":"こんな悩みはありませんか？","meeting":{"title":"会議中","description":"集中したいのに、メモを取るのに気を取られる"},"interview":{"title":"インタビュー中","description":"話に集中したいが、すべての言葉を記録する必要がある"},"lecture":{"title":"講演を聞く時","description":"母国語でないので理解が困難、話すスピードについていけない"}},"features":{"title":"Dopi Note がお手伝い","assistant":{"title":"最強の会議アシスタント","items":["多言語を自動認識、素早く文字起こしを生成","シナリオを自動識別、トレース可能な要約を生成","会議記録を自動であなたの言語に翻訳"]},"security":{"title":"最も安全なデータ管理","items":["ログイン不要、完全オフラインで使用可能","ログインでクラウド同期、データ紛失の心配なし"]},"pricing":{"title":"最も柔軟な料金体系","items":["サブスクリプション不要、時間を購入して全機能を享受","使った分だけ購入、超柔軟","時間は永続有効"]}},"slogan":{"title":"あなたは集中するだけ、AIがノート"},"download":{"title":"Dopi Note - 究極の会議アシスタント"},"contact":{"label":"お問い合わせ：","email":"yijhen.yang@gmail.com"},"footer":{"copyright":"© 2025 Dopi Note. All rights reserved."}},
  "es": {"meta":{"title":"Dopi Note — Grabación de reuniones, transcripción en 1 minuto","description":"Dopi Note: Notas de grabación inteligente AI, transcripción completa y resumen de puntos clave en 1 minuto. Sin inicio de sesión requerido, alta privacidad, soporta más de 20 idiomas."},"og":{"title":"Dopi Note — Grabación de reuniones, transcripción en 1 minuto","description":"Resumen inteligente AI hace que cada palabra sea valiosa. Sin inicio de sesión requerido, alta privacidad, soporta más de 20 idiomas."},"nav":{"brand":"Dopi Note","download":"Descargar Ahora"},"useCases":{"title":"¿También enfrentas estos desafíos?","meeting":{"title":"Durante Reuniones","description":"Quiero concentrarme pero tengo que tomar notas"},"interview":{"title":"Durante Entrevistas","description":"Espero escuchar atentamente pero necesito grabar cada palabra"},"lecture":{"title":"Durante Conferencias","description":"El idioma no nativo es difícil de entender, el ritmo rápido es difícil de seguir"}},"features":{"title":"Dopi Note Está Aquí Para Ayudar","assistant":{"title":"Asistente de Reuniones Más Poderoso","items":["Reconoce automáticamente múltiples idiomas, genera transcripciones rápidamente","Identifica automáticamente escenarios, genera resúmenes trazables","Traduce automáticamente los registros de reuniones a tu idioma"]},"security":{"title":"Gestión de Datos Más Segura","items":["Sin inicio de sesión requerido, completamente disponible sin conexión","Inicia sesión para sincronización en la nube, sin preocupación por pérdida de datos"]},"pricing":{"title":"Modelo de Pago Más Flexible","items":["Sin suscripción, compra horas para disfrutar de todas las características","Paga según uses, súper flexible","Las horas nunca expiran"]}},"slogan":{"title":"Solo concéntrate, deja que la IA tome notas"},"download":{"title":"Dopi Note - El Mejor Asistente de Reuniones"},"contact":{"label":"Contáctanos:","email":"yijhen.yang@gmail.com"},"footer":{"copyright":"© 2025 Dopi Note. All rights reserved."}}
};

// 國際化 (i18n) 管理系統
class I18n {
  constructor() {
    this.currentLanguage = 'en'; // 預設英文
    this.translations = {};
    this.supportedLanguages = ['en', 'zh-TW', 'ja', 'es'];
    this.languageNames = {
      'en': 'English',
      'zh-TW': '繁體中文',
      'ja': '日本語',
      'es': 'Español'
    };
    this.documentClickBound = false; // 追蹤是否已綁定 document click

    this.init();
  }

  init() {
    // 偵測用戶語言偏好
    const detectedLang = this.detectLanguage();
    this.loadLanguage(detectedLang);
    this.updateContent();
    this.setupLanguageSwitcher();
  }

  detectLanguage() {
    // 1. 檢查 localStorage 中的偏好設定
    const storedLang = localStorage.getItem('preferred-language');
    if (storedLang && this.supportedLanguages.includes(storedLang)) {
      return storedLang;
    }

    // 2. 檢查瀏覽器語言設定
    const browserLang = navigator.language || navigator.languages?.[0];

    // 語言映射表
    const languageMapping = {
      'zh-TW': 'zh-TW',
      'zh-HK': 'zh-TW',
      'zh-CN': 'zh-TW', // 簡體也顯示繁體
      'zh': 'zh-TW',
      'ja': 'ja',
      'ja-JP': 'ja',
      'es': 'es',
      'es-ES': 'es',
      'es-MX': 'es',
      'es-AR': 'es',
      'en': 'en',
      'en-US': 'en',
      'en-GB': 'en'
    };

    // 檢查完整語言代碼
    if (languageMapping[browserLang]) {
      return languageMapping[browserLang];
    }

    // 檢查語言代碼的主要部分
    const mainLang = browserLang?.split('-')[0];
    if (languageMapping[mainLang]) {
      return languageMapping[mainLang];
    }

    // 預設返回英文
    return 'en';
  }

  loadLanguage(lang) {
    if (!this.supportedLanguages.includes(lang)) {
      lang = 'en'; // 回退到英文
    }

    try {
      // 從嵌入的語言資料讀取
      if (LANGUAGE_DATA[lang]) {
        this.translations = LANGUAGE_DATA[lang];
        this.currentLanguage = lang;

        // 儲存用戶偏好
        localStorage.setItem('preferred-language', lang);

        // 更新 HTML lang 屬性
        document.documentElement.lang = lang;
      } else {
        throw new Error(`Language data not found: ${lang}`);
      }
    } catch (error) {
      console.error('Error loading language:', error);

      // 如果不是英文且載入失敗，回退到英文
      if (lang !== 'en') {
        this.loadLanguage('en');
      }
    }
  }

  getText(key) {
    const keys = key.split('.');
    let value = this.translations;

    for (const k of keys) {
      // 處理陣列索引
      if (!isNaN(k) && Array.isArray(value)) {
        value = value[parseInt(k)];
      } else {
        value = value?.[k];
      }
      if (value === undefined) break;
    }

    return value || key; // 如果找不到翻譯，返回原 key
  }

  updateContent() {
    // 更新所有具有 data-i18n 屬性的元素
    const elements = document.querySelectorAll('[data-i18n]');

    elements.forEach(element => {
      const key = element.getAttribute('data-i18n');
      const text = this.getText(key);

      if (text && text !== key) {
        // 檢查是否是輸入框的 placeholder
        if (element.hasAttribute('placeholder')) {
          element.setAttribute('placeholder', text);
        } else {
          element.textContent = text;
        }
      }
    });

    // 更新 meta 標籤
    this.updateMetaTags();
  }

  updateMetaTags() {
    // 更新 title
    if (this.translations.meta?.title) {
      document.title = this.translations.meta.title;
    }

    // 更新 meta description
    const metaDesc = document.querySelector('meta[name="description"]');
    if (metaDesc && this.translations.meta?.description) {
      metaDesc.setAttribute('content', this.translations.meta.description);
    }

    // 更新 og:title
    const ogTitle = document.querySelector('meta[property="og:title"]');
    if (ogTitle && this.translations.og?.title) {
      ogTitle.setAttribute('content', this.translations.og.title);
    }

    // 更新 og:description
    const ogDesc = document.querySelector('meta[property="og:description"]');
    if (ogDesc && this.translations.og?.description) {
      ogDesc.setAttribute('content', this.translations.og.description);
    }
  }

  setupLanguageSwitcher() {
    // 建立語言切換器
    this.createLanguageSwitcher();
  }

  createLanguageSwitcher() {
    // 檢查是否已存在語言切換器
    if (document.querySelector('.language-switcher')) {
      return;
    }

    // 建立語言切換器容器
    const switcher = document.createElement('div');
    switcher.className = 'language-switcher';

    // 建立當前語言顯示按鈕
    const currentLangBtn = document.createElement('button');
    currentLangBtn.className = 'current-language';
    currentLangBtn.textContent = this.languageNames[this.currentLanguage];
    currentLangBtn.setAttribute('aria-label', 'Language selector');

    // 建立語言選項下拉選單
    const dropdown = document.createElement('div');
    dropdown.className = 'language-dropdown';

    this.supportedLanguages.forEach(lang => {
      if (lang !== this.currentLanguage) {
        const option = document.createElement('button');
        option.className = 'language-option';
        option.textContent = this.languageNames[lang];
        option.setAttribute('data-lang', lang);

        // 使用立即執行函數避免閉包問題
        ((selectedLang) => {
          option.addEventListener('click', (e) => {
            e.stopPropagation();
            this.switchLanguage(selectedLang);
          });
        })(lang);

        dropdown.appendChild(option);
      }
    });

    // 組裝語言切換器
    switcher.appendChild(currentLangBtn);
    switcher.appendChild(dropdown);

    // 加入到頁面底部的聯絡資訊區
    const contactInfo = document.querySelector('.contact-info');
    if (contactInfo) {
      contactInfo.appendChild(switcher);
    }

    // 點擊切換下拉選單顯示/隱藏
    currentLangBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      dropdown.classList.toggle('show');
    });

    // 點擊其他地方關閉下拉選單（只綁定一次）
    if (!this.documentClickBound) {
      document.addEventListener('click', () => {
        const anyDropdown = document.querySelector('.language-dropdown.show');
        if (anyDropdown) {
          anyDropdown.classList.remove('show');
        }
      });
      this.documentClickBound = true;
    }
  }

  switchLanguage(lang) {
    if (lang === this.currentLanguage) return;

    this.loadLanguage(lang);
    this.updateContent();

    // 更新語言切換器
    const switcher = document.querySelector('.language-switcher');
    if (switcher) {
      switcher.remove();
      this.createLanguageSwitcher();
    }
  }
}

// 初始化國際化系統
document.addEventListener('DOMContentLoaded', () => {
  const i18n = new I18n();
  // 導出給其他腳本使用
  window.i18n = i18n;
});